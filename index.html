<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Silent Defense - Reworked Layout and UI</title>
    <style>
        :root {
            --grid-cols: 15; /* New Width */
            --grid-rows: 4;  /* New Height */
            --cell-size: 60px; /* Reduced cell size for fitting more tiles */
            --grid-width: calc(var(--grid-cols) * var(--cell-size));
            --grid-height: calc(var(--grid-rows) * var(--cell-size));

            --dark-color: #1a1a2e;
            --accent-color: #e94560;
            --gold-color: gold;
            --power-color: #00ffff;
            --door-color: #a0522d;
            --door-knob-color: #ffd700;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end; 
            min-height: 100vh;
            margin: 0;
            background-color: var(--dark-color);
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
            padding-bottom: 50px; 
        }

        /* --- UI Bar (Top Left Fixed) --- */
        #ui-bar {
            position: fixed;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            padding: 15px;
            background-color: #272744;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            z-index: 200;
            gap: 10px;
        }

        .resource-display {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4em;
        }
        
        #gold-amount { color: var(--gold-color); font-weight: bold; }
        #power-amount { color: var(--power-color); font-weight: bold; }
        
        /* --- Monster Stats UI (Top Right Fixed) --- */
        #monster-stats-bar {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            padding: 15px;
            background-color: #442727;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            z-index: 200;
            gap: 10px;
        }

        .stat-display {
            font-size: 1.1em;
            color: #ccc;
        }
        .stat-value {
            font-weight: bold;
            color: var(--accent-color);
        }

        /* --- Game Container & Grid --- */
        #game-container {
            position: relative;
            width: var(--grid-width);
            height: var(--grid-height);
            margin: 20px auto; 
            border: 5px solid #333;
            background-color: #0a0a0a;
            box-sizing: content-box;
            z-index: 10;
        }
        
        /* --- Door Styles & HP Bar --- */
        #door {
            position: absolute;
            /* Door remains vertically centered on the top edge */
            top: calc(0px - 30px); 
            left: 50%;
            transform: translateX(-50%);
            width: var(--cell-size);
            height: 30px;
            background-color: var(--door-color);
            border: 3px solid black;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: background-color 0.05s linear, opacity 1s ease-out; 
        }

        /* FIX: Door Knob above the door */
        #door-knob {
            position: absolute;
            right: 10px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--door-knob-color);
            z-index: 101; /* Ensure knob is visible */
        }

        

        /* --- Monster Styles & HP Bar --- */
        #monster {
            position: absolute;
            /* FIX: Monster stays further away (approx 1.5 cell sizes above the door) */
            top: calc(0px - 60px - 30px); 
            left: 50%;
            transform: translateX(-50%);
            font-size: 4em; /* Larger size */
            transition: opacity 0.5s, transform 0.1s, top 1s ease-in-out, left 1s ease-in-out;
            z-index: 99;
            opacity: 1;
        }
        
        /* New: Monster Health Bar Container (attached to monster) */
        #monster-hp-visual {
            position: absolute;
            width: 40px; 
            height: 6px;
            background-color: gray;
            border-radius: 2px;
            overflow: hidden;
            /* Positioned just above the monster emoji */
            top: -10px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 100; 
        }
        #monster-hp-fill {
            height: 100%;
            width: 100%;
            background-color: var(--accent-color); /* Red */
            transition: width 0.3s ease;
        }

        /* --- Animations & Visuals --- */
        .upgrade-available {
            box-shadow: inset 0 0 0 4px rgba(0, 255, 0, 0.3); 
        }

        /* FIX: Increased vertical slam movement for door attack */
        @keyframes slam {
            0% { transform: translate(-50%, 0px); }
            50% { transform: translate(-50%, 15px); } /* Increased Y movement */
            100% { transform: translate(-50%, 0px); }
        }

        .monster-slam {
            animation: slam 0.2s ease-out;
        }
        
        .monster-hit {
            opacity: 0.5 !important;
            transition: opacity 0.05s ease-out !important;
        }
        
        /* FIX: Smooth pulse for build mode plus signs */
        @keyframes pulse {
            0% { opacity: 0.5; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.1); } /* Peak */
            100% { opacity: 0.5; transform: scale(0.8); } /* Returns smoothly to start */
        }
        /* FIX: Smooth pulse for build mode plus signs */
        .build-plus {
            position: absolute; 
            font-size: 2em; 
            color: rgba(192, 192, 192, 0.6); 
            /* Seamlessly loop the pulse animation (removed 'alternate') */
            animation: pulse 1s infinite ease-in-out; 
            pointer-events: none; 
        }
        
        /* --- Grid & Structures --- */
        #game-grid {
            display: grid;
            grid-template-columns: repeat(var(--grid-cols), var(--cell-size));
            grid-template-rows: repeat(var(--grid-rows), var(--cell-size));
            width: 100%;
            height: 100%;
            background-color: #000;
        }
        .grid-tile {
            width: var(--cell-size);
            height: var(--cell-size);
            border: 1px solid #444; 
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            user-select: none;
            cursor: pointer;
            transition: box-shadow 0.2s ease;
        }
        .structure-icon {
            font-size: 2.5em; 
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        /* Turret (Bow) rotation setup */
        .turret-bow {
            display: inline-block;
            transform-origin: 50% 50%;
            transition: transform 0.2s linear; /* Smooth rotation */
        }
        
        /* Projectile */
        .projectile {
            position: absolute;
            font-size: 1.5em;
            color: yellow;
            transition: all 0.5s linear; 
            z-index: 110;
            transform-origin: center center; /* Ensure rotation is centered */
        }

        /* --- Floating Resources --- */
        .floating-resource {
            position: absolute;
            font-size: 1.2em; 
            font-weight: bold;
            pointer-events: none;
            z-index: 150;
            animation: drift-and-fade 1s ease-out forwards;
        }
        
        @keyframes drift-and-fade {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(0, -30px) scale(0.6); opacity: 0; }
        }
        
        .floating-gold { color: var(--gold-color); }
        .floating-power { color: var(--power-color); }

        /* --- Menu and Tooltip styles retained --- */
        .info-tooltip {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8); color: white; padding: 5px 10px; border-radius: 5px;
            font-size: 0.8em; white-space: nowrap; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s; pointer-events: none; z-index: 300;
        }
        #door:hover .info-tooltip,
        .grid-tile:hover .info-tooltip { opacity: 1; visibility: visible; }
        #menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 250; }
        #action-menu, #build-menu { background-color: #272744; padding: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); text-align: center; }
        .menu-title { font-size: 1.5em; margin-bottom: 15px; color: var(--accent-color); }
        .menu-button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: background-color 0.2s; }
        #upgrade-btn { background-color: #4CAF50; color: white; }
        #sell-btn { background-color: #f44336; color: white; }
        #close-btn { background-color: #555; color: white; margin-top: 15px; }
        .disabled-btn { background-color: #888 !important; cursor: not-allowed !important; }

        .hint {
            position: fixed;
            bottom: 10px;
            color: rgba(255, 255, 255, 0.7);
            z-index: 50;
        }
    </style>
</head>
<body>

    <div id="ui-bar">
        <div class="resource-display">üí∞ Gold: <span id="gold-amount">100</span></div>
        <div class="resource-display">‚ö° Power: <span id="power-amount">0</span></div>
        <div class="resource-display">Wave: <span id="wave-count">1</span></div>
    </div>
    
    <div id="monster-stats-bar">
        <div class="stat-display">
            Monster Stats
        </div>
        <div class="stat-display">
            Damage: <span id="monster-damage" class="stat-value">0</span>
        </div>
        <div class="stat-display">
            Wave: <span id="monster-wave" class="stat-value">1</span>
        </div>
        <div class="stat-display">
            Amount: <span class="stat-value">1</span> (Current)
        </div>
    </div>

    <div id="game-container">
        <div id="door-hp-visual"><div id="door-hp-fill-overlay"></div></div>

        <div id="door" class="tooltip-container">
            <div id="door-knob"></div>
            <span class="info-tooltip" id="door-tooltip"></span>
        </div>
        
        <div id="monster">
            <div id="monster-hp-visual"><div id="monster-hp-fill"></div></div>
            üíÄ
        </div>
        
        <div id="game-grid">
            </div>
    </div>


    <div id="menu-overlay">
        <div id="action-menu">
            <div class="menu-title" id="menu-title"></div>
            <p id="menu-info"></p>
            <button class="menu-button" id="upgrade-btn"></button>
            <button class="menu-button" id="sell-btn"></button>
            <button class="menu-button" id="close-btn">Close</button>
        </div>
        
        <div id="build-menu" style="display: none;">
            <div class="menu-title">Place Structure</div>
            <button class="menu-button" onclick="placeStructure('turret')" data-cost="150">üèπ Turret (150üí∞)</button>
            <button class="menu-button" onclick="placeStructure('generator')" data-cost="100">üè≠ Generator (100üí∞)</button>
            <button class="menu-button" onclick="closeMenu()">Cancel</button>
        </div>
    </div>

    <script>
    // --- 1. ROBUST UI INJECTION & GRAPH SETUP ---
    
    // A. Action Menu (Upgrade Popup)
    if (!document.getElementById('action-menu')) {
        const menuDiv = document.createElement('div');
        menuDiv.id = 'action-menu';
        menuDiv.innerHTML = `
            <div id="menu-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1999;"></div>
            <h2 id="menu-title">Level 1</h2>
            <div id="menu-info">Stats here</div>
            <div class="action-btn-group">
                <button id="upgrade-btn">Upgrade</button>
                <button id="sell-btn">Sell</button>
                <button id="close-btn">Close</button>
            </div>
        `;
        document.body.appendChild(menuDiv);
    }

    // B. Power Usage Graph & Display
    if (!document.getElementById('energy-monitor-container')) {
        const monitorDiv = document.createElement('div');
        monitorDiv.id = 'energy-monitor-container';
        monitorDiv.innerHTML = `
            <div class="monitor-label">GRID LOAD (kW)</div>
            <canvas id="energy-graph" width="140" height="40"></canvas>
            <div id="kw-readout">0.0 kW</div>
        `;
        document.body.appendChild(monitorDiv);
    }

    // C. Door HP Bar
    if (!document.getElementById('ui-door-hp-container')) {
        const hpContainer = document.createElement('div');
        hpContainer.id = 'ui-door-hp-container';
        hpContainer.innerHTML = `<div id="ui-door-hp-fill"></div><div id="ui-door-hp-text">Door HP</div>`;
        document.body.appendChild(hpContainer);
    }

    // D. Toast Notification
    if (!document.getElementById('game-toast')) {
        const toastDiv = document.createElement('div');
        toastDiv.id = 'game-toast';
        document.body.appendChild(toastDiv);
    }

    // --- 2. CSS STYLES ---
    const styleFix = document.createElement('style');
    styleFix.innerHTML = `
        /* --- ENERGY GRAPH CONTAINER --- */
        #energy-monitor-container {
            position: fixed;
            top: 10px;
            left: 220px; /* Positioned to the right of the default top-left stats box */
            width: 150px;
            height: 70px;
            background: #111;
            border: 2px solid #555;
            border-radius: 6px;
            padding: 5px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .monitor-label { font-size: 10px; color: #888; letter-spacing: 1px; width: 100%; text-align: left; margin-bottom: 2px; }
        #energy-graph { background: #000; border: 1px solid #333; }
        #kw-readout { font-family: 'Courier New', monospace; color: #ff4444; font-weight: bold; font-size: 12px; margin-top: 2px; width: 100%; text-align: right; }

        /* TABS */
        .tab-container { display: flex; justify-content: space-between; margin-bottom: 10px; background: #222; padding: 5px; border-radius: 8px; }
        .tab-btn {
            flex: 1; background: transparent; border: none; color: #888; 
            padding: 8px; cursor: pointer; font-weight: bold; border-bottom: 2px solid transparent;
        }
        .tab-btn.active { color: white; border-bottom: 2px solid #ffd700; }
        .tab-btn:hover { color: #ccc; }

        /* SHUTDOWN STATE */
        .grid-tile.shutdown { opacity: 0.6; filter: grayscale(80%); border: 2px solid #ff0000; }
        .shutdown-icon {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 24px; animation: blinkWarning 1s infinite; pointer-events: none; z-index: 10;
        }
        @keyframes blinkWarning { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* POWER DRAIN ANIMATION */
        .power-drain-text {
            position: absolute; color: #ff4444; font-weight: bold; font-size: 16px;
            pointer-events: none; animation: slideRightFade 0.8s forwards; z-index: 2000;
            text-shadow: 1px 1px 0 #000;
        }
        @keyframes slideRightFade {
            0% { opacity: 1; transform: translate(0, 0); }
            100% { opacity: 0; transform: translate(30px, -10px); }
        }

        /* MENUS & TOASTS */
        #game-toast {
            position: fixed; top: -150px; left: 50%; transform: translateX(-50%);
            width: 70%; background: rgba(0, 0, 0, 0.95); 
            border: 3px solid #ff4444; border-top: none;
            border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;
            color: white; padding: 20px; text-align: center;
            font-size: 24px; font-weight: bold; z-index: 10000;
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #game-toast.show { top: 0; }
        #game-toast.danger { border-color: #ff0000; color: #ffcccc; }
        
        #action-menu {
            display: none; position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); width: 300px; 
            background: #2a2a2a; border: 4px solid #fff; border-radius: 12px; 
            padding: 20px; text-align: center; color: white; 
            z-index: 2000; box-shadow: 0 10px 50px rgba(0,0,0,1);
        }
        #menu-title { margin-top: 0; font-size: 24px; color: #ffd700; text-shadow: 2px 2px 0 #000; }
        #menu-info { margin-bottom: 20px; color: #ccc; font-size: 14px; }
        .action-btn-group { display: flex; flex-direction: column; gap: 12px; }
        
        #upgrade-btn, #sell-btn, #close-btn {
            width: 100%; padding: 15px; border: none; border-radius: 8px;
            font-size: 18px; font-weight: bold; cursor: pointer; color: white;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.5); position: relative;
        }
        #upgrade-btn { background: #28a745; box-shadow: 0 6px 0 #1e7e34; }
        #upgrade-btn:active { top: 6px; box-shadow: none; }
        #sell-btn { background: #d9534f; box-shadow: 0 6px 0 #c9302c; }
        #sell-btn:active { top: 6px; box-shadow: none; }
        #close-btn { background: #555; box-shadow: 0 6px 0 #333; margin-top: 10px; }
        #close-btn:active { top: 6px; box-shadow: none; }
        .disabled-btn { background-color: #444 !important; color: #888 !important; box-shadow: none !important; cursor: not-allowed; pointer-events: none; top: 6px; }

        #build-menu {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 400px; max-height: 80vh;
            background: #2a2a2a; border: 4px solid #4a4a4a; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.8); z-index: 2000;
            overflow-y: auto; padding: 10px; scrollbar-width: none;
        }
        #build-menu::-webkit-scrollbar { display: none; }
        .shop-card {
            display: flex; align-items: center; background: #333;
            margin-bottom: 10px; border-radius: 8px; border: 2px solid #555;
            padding: 10px; height: 100px; transition: transform 0.1s;
        }
        .shop-card:hover { border-color: #ffd700; transform: scale(1.02); }
        .shop-card.disabled { opacity: 0.6; filter: grayscale(100%); pointer-events: none; }
        .card-info { flex: 1; display: flex; flex-direction: column; padding-right: 10px; }
        .card-title { font-size: 18px; font-weight: bold; color: #fff; margin-bottom: 4px; }
        .card-desc { font-size: 12px; color: #aaa; margin-bottom: 8px; }
        .card-action { display: flex; align-items: center; gap: 10px; }
        .card-price { font-size: 14px; color: #ffd700; font-weight: bold; }
        .card-buy-btn { background: #28a745; border: none; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .card-icon { font-size: 60px; line-height: 1; height: 90%; display: flex; align-items: center; }

        .build-plus { animation: smoothPulse 3s infinite ease-in-out !important; }
        @keyframes smoothPulse { 0% { opacity: 0.5; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.8); } }
        .monster-slam { animation: slam 0.2s ease-in-out !important; }
        @keyframes slam { 0% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, 20px); } 100% { transform: translate(-50%, 0); } }
        .door-shake { animation: shakeDoor 0.3s ease-in-out; }
        @keyframes shakeDoor { 0% { transform: translateX(-50%) rotate(0deg); } 25% { transform: translateX(-50%) rotate(-5deg); } 50% { transform: translateX(-50%) rotate(5deg); } 75% { transform: translateX(-50%) rotate(-5deg); } 100% { transform: translateX(-50%) rotate(0deg); } }

        .floating-group {
            display: flex; gap: 8px; position: absolute; font-size: 1.2em; 
            font-weight: bold; pointer-events: none; z-index: 150;
            animation: drift-and-fade 1s ease-out forwards;
            white-space: nowrap; text-shadow: 1px 1px 0 #000;
        }
        @keyframes drift-and-fade {
            0% { transform: translate(0, 0); opacity: 1; }
            100% { transform: translate(0, -30px); opacity: 0; }
        }
        
        #ui-door-hp-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 300px; height: 20px; background: #333;
            border: 2px solid #fff; border-radius: 10px; overflow: hidden;
            z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }
        #ui-door-hp-fill { height: 100%; width: 100%; background: #00ff00; transition: width 0.2s; }
        #ui-door-hp-text {
            position: absolute; width: 100%; text-align: center; top: 0;
            line-height: 20px; color: white; font-size: 12px;
            font-weight: bold; text-shadow: 1px 1px 0 #000;
        }
    `;
    document.head.appendChild(styleFix);

    // --- 3. GAME CONSTANTS & DATA ---
    const GRID_COLS = 15;
    const GRID_ROWS = 4;
    const CELL_SIZE = 60;
    const TILE_COUNT = GRID_COLS * GRID_ROWS;
    const BED_TILE_INDEX = (GRID_ROWS - 2) * GRID_COLS + Math.floor(GRID_COLS / 2); 

    const DOOR_LEVELS = [
        { cost: 0, health: 300, color: '#8B4513', knob: '#FFD700', name: 'Wood Door' },
        { cost: 100, health: 500, color: '#708090', knob: '#C0C0C0', name: 'Iron Door' },
        { cost: 250, health: 800, color: '#C0C0C0', knob: '#FF4500', name: 'Steel Door' },
        { cost: 500, health: 1200, color: '#FFD700', knob: '#00FFFF', name: 'Gold Door' },
        { cost: 1000, health: 2000, color: '#9932CC', knob: '#FFFF00', name: 'Dark Matter' },
    ];
    const BED_LEVELS = [
        { cost: 0, goldGen: 100, powerGen: 1 }, 
        { cost: 200, goldGen: 200, powerGen: 2 },
        { cost: 500, goldGen: 450, powerGen: 3 },
        { cost: 1200, goldGen: 900, powerGen: 5 },
        { cost: 3000, goldGen: 2000, powerGen: 10 }
    ];
    const GENERATOR_LEVELS = [
        { cost: 100, goldGen: 0, powerGen: 1 }, { cost: 200, goldGen: 0, powerGen: 3 },
        { cost: 450, goldGen: 0, powerGen: 6 }, { cost: 900, goldGen: 0, powerGen: 12 },
        { cost: 1800, goldGen: 0, powerGen: 25 }
    ];
    const TURRET_LEVELS = [
        { cost: 150, damage: 20, fireRate: 1500 }, { cost: 300, damage: 35, fireRate: 1200 },
        { cost: 600, damage: 60, fireRate: 900 }, { cost: 1200, damage: 100, fireRate: 700 },
        { cost: 2500, damage: 180, fireRate: 500 }
    ];
    const BANK_LEVELS = [
        { cost: 500, multiplier: 1, powerDrain: 1 }, 
        { cost: 1200, multiplier: 2, powerDrain: 2 },
        { cost: 2500, multiplier: 4, powerDrain: 3 },
        { cost: 5000, multiplier: 8, powerDrain: 4 },
        { cost: 10000, multiplier: 16, powerDrain: 5 }
    ];
    
    const STRUCTURES = {
        door: { levels: DOOR_LEVELS, icon: 'üö™' },
        bed: { levels: BED_LEVELS, icon: 'üõèÔ∏è' },
        generator: { levels: GENERATOR_LEVELS, icon: '‚òÄÔ∏è' },
        turret: { levels: TURRET_LEVELS, icon: 'üèπ' },
        bank: { levels: BANK_LEVELS, icon: 'üè¶' }
    };

    const SHOP_ITEMS = [
        { type: 'generator', category: 'default', name: 'Solar Panel', desc: 'Generates Power.', icon: '‚òÄÔ∏è' },
        { type: 'turret', category: 'default', name: 'Crossbow', desc: 'Shoots monsters.', icon: 'üèπ' },
        { type: 'bank', category: 'electrical', name: 'Crypto Bank', desc: 'Buffs Turrets. Consumes Power!', icon: 'üè¶' }
    ];

    const MONSTER_LEVELS = [
        { hp: 500, damage: 5, attackRate: 1500 },
        { hp: 800, damage: 10, attackRate: 1400 },
        { hp: 1300, damage: 20, attackRate: 1300 },
        { hp: 2100, damage: 40, attackRate: 1200 },
        { hp: 3500, damage: 60, attackRate: 1100 },
        { hp: 6000, damage: 90, attackRate: 1000 },
        { hp: 10000, damage: 150, attackRate: 800 },
    ];

    // --- 4. GAME STATE ---
    let gold = 100;
    let power = 100;
    let isBuildMode = false; 
    let isGameOver = false; 
    let currentShopTab = 'default';

    // Graph Data
    const graphHistory = Array(30).fill(0); // Store last 30 ticks
    
    let door = { type: 'door', level: 1, hp: DOOR_LEVELS[0].health, maxHp: DOOR_LEVELS[0].health };
    let monster = { level: 1, hp: 500, maxHp: 500, damage: 5, attackRate: 1500, isAttacking: true };
    let currentTileTarget = null; 

    // Initialize Grid with Bed
    let tiles = Array(TILE_COUNT).fill(null).map((_, index) => {
        if (index === BED_TILE_INDEX) {
            return { type: 'bed', level: 1, goldEffect: 100, powerEffect: 1, cost: 0, isDisabled: false, element: null };
        }
        return null;
    });

    // --- 5. DOM REFERENCES ---
    const uiGold = document.getElementById('gold-amount');
    const uiPower = document.getElementById('power-amount');
    const uiKwReadout = document.getElementById('kw-readout');
    const graphCanvas = document.getElementById('energy-graph');
    const ctx = graphCanvas ? graphCanvas.getContext('2d') : null;

    const uiWave = document.getElementById('wave-count');
    const monsterDamageDisplay = document.getElementById('monster-damage');
    const monsterWaveDisplay = document.getElementById('monster-wave');
    const doorElement = document.getElementById('door');
    const monsterElement = document.getElementById('monster');
    const monsterHpFill = document.getElementById('monster-hp-fill');
    const gridElement = document.getElementById('game-grid');
    const upgradeBtn = document.getElementById('upgrade-btn');
    const sellBtn = document.getElementById('sell-btn');
    const closeBtn = document.getElementById('close-btn');
    const doorHpFill = document.getElementById('ui-door-hp-fill');
    const doorHpText = document.getElementById('ui-door-hp-text');
    const toastElement = document.getElementById('game-toast');

    let monsterAttackInterval = null;

    // --- 6. UTILITY FUNCTIONS ---
    function showToast(msg, type = 'neutral') {
        if(!toastElement) return;
        toastElement.textContent = msg;
        toastElement.className = ''; 
        if(type === 'danger') toastElement.classList.add('danger');
        if(type === 'success') toastElement.classList.add('success');
        toastElement.classList.add('show');
        setTimeout(() => toastElement.classList.remove('show'), 3000);
    }

    function animatePowerLoss(amount) {
        if (!uiPower) return;
        const rect = uiPower.getBoundingClientRect();
        const anim = document.createElement('span');
        anim.textContent = `-${amount}`;
        anim.className = 'power-drain-text';
        anim.style.left = (rect.right + 10) + 'px';
        anim.style.top = rect.top + 'px';
        document.body.appendChild(anim);
        setTimeout(() => anim.remove(), 1000);
    }

    function displayFloatingResourceGroup(sourceElement, goldAmount, powerAmount) {
        if (!sourceElement) return;
        const rect = sourceElement.getBoundingClientRect();
        const group = document.createElement('div');
        group.className = 'floating-group';
        
        const startX = rect.left + rect.width / 2;
        const startY = rect.top; 

        if (goldAmount > 0) {
            const gSpan = document.createElement('span');
            gSpan.textContent = `+${goldAmount}üí∞`;
            gSpan.style.color = 'gold';
            group.appendChild(gSpan);
        }
        if (powerAmount > 0) {
            const pSpan = document.createElement('span');
            pSpan.textContent = `+${powerAmount}‚ö°`;
            pSpan.style.color = '#00ffff';
            group.appendChild(pSpan);
        }
        
        group.style.left = `${startX}px`; 
        group.style.top = `${startY}px`;
        document.body.appendChild(group); 
        setTimeout(() => group.remove(), 1000); 
    }

    function drawEnergyGraph(currentLoad) {
        if (!ctx) return;
        
        // Update History
        graphHistory.shift();
        graphHistory.push(currentLoad);

        // Clear
        const w = graphCanvas.width;
        const h = graphCanvas.height;
        ctx.clearRect(0, 0, w, h);

        // Find scale (max value in history or at least 10)
        const maxVal = Math.max(10, ...graphHistory);
        
        ctx.beginPath();
        ctx.strokeStyle = '#ff4444';
        ctx.lineWidth = 2;
        ctx.fillStyle = 'rgba(255, 68, 68, 0.2)';

        // Draw Line
        const step = w / (graphHistory.length - 1);
        ctx.moveTo(0, h - (graphHistory[0] / maxVal) * h);

        for(let i = 1; i < graphHistory.length; i++) {
            const x = i * step;
            const y = h - (graphHistory[i] / maxVal) * h;
            ctx.lineTo(x, y);
        }

        // Fill Area
        ctx.stroke();
        ctx.lineTo(w, h);
        ctx.lineTo(0, h);
        ctx.fill();

        // Draw Grid Lines (visual flair)
        ctx.beginPath();
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1;
        ctx.moveTo(0, h/2);
        ctx.lineTo(w, h/2);
        ctx.stroke();
    }

    // --- 7. GAME LOOPS ---
    
    // Resource Income Loop & Passive Regen
    setInterval(() => {
        if (isGameOver) return;
        let goldIncome = 0; 
        let powerIncome = 0;

        tiles.forEach(tile => {
            if (tile && !tile.isDisabled) {
                if(tile.goldEffect) goldIncome += tile.goldEffect;
                if(tile.powerEffect) powerIncome += tile.powerEffect;
                
                if ((tile.goldEffect > 0 || tile.powerEffect > 0) && tile.element) {
                    displayFloatingResourceGroup(tile.element, tile.goldEffect, tile.powerEffect);
                }
            }
        });
        gold += goldIncome;
        power += powerIncome;

        // --- NEW: DOOR REGEN (2% per sec) ---
        if (door.hp < door.maxHp && door.hp > 0) {
            const healAmount = door.maxHp * 0.02;
            door.hp = Math.min(door.maxHp, door.hp + healAmount);
        }

        updateUI();
    }, 1000);

    // Power Consumption Loop (Logic + Graph Update)
    setInterval(() => {
        if (isGameOver) return;
        
        let totalDrain = 0;
        let consumers = [];

        tiles.forEach(tile => {
            if (tile && tile.type === 'bank') {
                const stats = STRUCTURES.bank.levels[tile.level - 1];
                totalDrain += stats.powerDrain;
                consumers.push(tile);
            }
        });

        // Jitter for realism
        const jitter = totalDrain > 0 ? (Math.random() * 0.5 - 0.25) : 0;
        const displayVal = Math.max(0, totalDrain + jitter);
        
        // Update Graph & Text
        drawEnergyGraph(displayVal);
        if(uiKwReadout) uiKwReadout.textContent = displayVal.toFixed(1) + " kW";

        if (totalDrain > 0) {
            if (power >= totalDrain) {
                power -= totalDrain;
                animatePowerLoss(totalDrain);
                consumers.forEach(t => {
                    t.isDisabled = false;
                    if(t.element) {
                        t.element.classList.remove('shutdown');
                        const warn = t.element.querySelector('.shutdown-icon');
                        if(warn) warn.remove();
                    }
                });
            } else {
                consumers.forEach(t => {
                    t.isDisabled = true;
                    if(t.element && !t.element.querySelector('.shutdown-icon')) {
                        t.element.classList.add('shutdown');
                        const icon = document.createElement('div');
                        icon.className = 'shutdown-icon';
                        icon.textContent = '‚ö†Ô∏è';
                        t.element.appendChild(icon);
                    }
                });
            }
        }
        updateUI();
    }, 1000);

    // --- 8. LOGIC (Combat, Build, Upgrade) ---
    function updateDoorVisuals() {
        if(!doorElement) return;
        const currentStats = DOOR_LEVELS[door.level - 1] || DOOR_LEVELS[DOOR_LEVELS.length-1];
        doorElement.style.backgroundColor = currentStats.color;
        const knob = document.getElementById('door-knob');
        if (knob) knob.style.backgroundColor = currentStats.knob;
    }

    function startMonsterAttack() {
        if (monsterAttackInterval) clearInterval(monsterAttackInterval);
        monsterAttackInterval = setInterval(() => {
            if (monster.isAttacking && !isGameOver) {
                monsterElement.classList.add('monster-slam');
                setTimeout(() => monsterElement.classList.remove('monster-slam'), 200);
                
                door.hp -= monster.damage;
                doorElement.classList.remove('door-shake');
                void doorElement.offsetWidth; 
                doorElement.classList.add('door-shake');

                if (door.hp <= 0) { door.hp = 0; endGameSequence(); return; }
                
                doorElement.classList.add('door-hit');
                setTimeout(() => doorElement.classList.remove('door-hit'), 50);

                updateUI();
            }
        }, monster.attackRate);
    }
    
    function damageMonster(damage) {
        if (isGameOver) return;
        monster.hp -= damage;
        monsterElement.classList.add('monster-hit');
        setTimeout(() => monsterElement.classList.remove('monster-hit'), 50);
        
        if (monster.hp <= 0) {
            monster.isAttacking = false;
            clearInterval(monsterAttackInterval);
            monsterElement.style.opacity = 0;
            gold += Math.round(monster.maxHp * 0.2); 
            monster.level++;
            showToast(`‚ö†Ô∏è WARNING: Monster Level ${monster.level} Incoming!`, 'danger');
            setTimeout(startWave, 2000); 
        }
        updateUI(); 
    }

    function endGameSequence() {
        isGameOver = true;
        monster.isAttacking = false;
        clearInterval(monsterAttackInterval);
        turretIntervals.forEach(clearInterval); 
        doorElement.style.opacity = 0; 
        showToast("‚ùå DOOR DESTROYED - GAME OVER", 'danger');
        
        const bedCol = BED_TILE_INDEX % GRID_COLS;
        const bedRow = Math.floor(BED_TILE_INDEX / GRID_COLS);
        monsterElement.style.transition = "all 1s";
        monsterElement.style.top = `${(bedRow * CELL_SIZE) + CELL_SIZE/2}px`;
        monsterElement.style.left = `${(bedCol * CELL_SIZE) + CELL_SIZE/2}px`;
    }

    let turretIntervals = [];
    function updateTurretIntervals() {
        turretIntervals.forEach(clearInterval);
        turretIntervals = [];

        tiles.forEach((tile, index) => {
            if (tile && tile.type === 'turret') {
                const stats = STRUCTURES.turret.levels[tile.level - 1];
                // Aim
                turretIntervals.push(setInterval(() => {
                    if (tile.element && monster.isAttacking && !isGameOver) aimTurret(tile); 
                }, 30));
                // Fire
                turretIntervals.push(setInterval(() => {
                    if (monster.isAttacking && !isGameOver) fireProjectile(index);
                }, stats.fireRate));
            }
        });
    }

    function aimTurret(tile) {
        if (!tile || !tile.element) return;
        const tRect = tile.element.getBoundingClientRect();
        const mRect = monsterElement.getBoundingClientRect();
        const deltaX = mRect.left - tRect.left;
        const deltaY = mRect.top - tRect.top;
        tile.currentRotation = (Math.atan2(deltaY, deltaX) * (180/Math.PI)) + 45;
        const bow = tile.element.querySelector('.turret-bow');
        if (bow) bow.style.transform = `rotate(${tile.currentRotation}deg)`;
    }

    function fireProjectile(index) {
        const tile = tiles[index];
        if (!tile.element) return;
        const stats = STRUCTURES.turret.levels[tile.level - 1];

        // Bank Logic
        let bankBonus = 0;
        tiles.forEach(t => {
            if (t && t.type === 'bank' && !t.isDisabled) {
                const bankStats = STRUCTURES.bank.levels[t.level - 1];
                bankBonus += bankStats.multiplier;
            }
        });

        if (bankBonus > 0) {
            gold += bankBonus;
            displayFloatingResourceGroup(tile.element, bankBonus, 0);
        }

        const proj = document.createElement('div');
        proj.className = 'projectile';
        proj.textContent = '‚ô¶Ô∏è'; 
        
        const tRect = tile.element.getBoundingClientRect();
        const cRect = document.getElementById('game-container').getBoundingClientRect();
        
        proj.style.left = `${tRect.left + tRect.width/2 - cRect.left}px`;
        proj.style.top = `${tRect.top + tRect.height/2 - cRect.top}px`;
        document.getElementById('game-container').appendChild(proj);
        
        const mRect = monsterElement.getBoundingClientRect();
        const destX = mRect.left + mRect.width/2 - cRect.left;
        const destY = mRect.top + mRect.height/2 - cRect.top;
        
        setTimeout(() => {
            proj.style.transform = `rotate(${Math.atan2(destY - parseFloat(proj.style.top), destX - parseFloat(proj.style.left))*180/Math.PI}deg)`;
            proj.style.left = `${destX}px`;
            proj.style.top = `${destY}px`;
        }, 10);
        
        setTimeout(() => { damageMonster(stats.damage); proj.remove(); }, 500); 
    }

    // --- 9. UI RENDERING ---
    function updateUI() {
        if(uiGold) uiGold.textContent = Math.floor(gold).toLocaleString();
        if(uiPower) uiPower.textContent = Math.floor(power).toLocaleString();
        if(uiWave) uiWave.textContent = monster.level;
        if(monsterDamageDisplay) monsterDamageDisplay.textContent = monster.damage;
        if(monsterWaveDisplay) monsterWaveDisplay.textContent = monster.level;

        const doorPercent = Math.max(0, (door.hp / door.maxHp) * 100);
        if(doorHpFill) {
            doorHpFill.style.width = `${doorPercent}%`;
            doorHpFill.style.backgroundColor = doorPercent > 50 ? '#00ff00' : (doorPercent > 25 ? '#ffff00' : '#ff0000');
        }
        if(doorHpText) doorHpText.textContent = `${DOOR_LEVELS[door.level-1].name} (${Math.round(door.hp)}/${door.maxHp})`;
        if(monsterHpFill) monsterHpFill.style.width = `${Math.max(0, (monster.hp / monster.maxHp) * 100)}%`;
    }

    function switchTab(tabName) {
        currentShopTab = tabName;
        if (isBuildMode) {
            const menu = document.getElementById('build-menu');
            const cards = menu.querySelectorAll('.shop-card');
            cards.forEach(c => c.remove());
            renderShopItems(menu);
            const buttons = menu.querySelectorAll('.tab-btn');
            buttons.forEach(btn => {
                if(btn.textContent.toLowerCase().includes(tabName)) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        }
    }

    function renderShopItems(container) {
        const filteredItems = SHOP_ITEMS.filter(item => item.category === currentShopTab);
        if (filteredItems.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'shop-card disabled';
            empty.innerHTML = `<div style="padding:20px; text-align:center; width:100%; color:#888;">Coming Soon</div>`;
            container.appendChild(empty);
            return;
        }

        filteredItems.forEach(item => {
            const cost = STRUCTURES[item.type].levels[0].cost;
            const canAfford = gold >= cost;
            const card = document.createElement('div');
            card.className = 'shop-card' + (canAfford ? '' : ' disabled');
            card.innerHTML = `
                <div class="card-info"><div class="card-title">${item.name}</div>
                <div class="card-desc">${item.desc}</div>
                <div class="card-action"><div class="card-price">${cost} üí∞</div>
                <button class="card-buy-btn">Buy</button></div></div>
                <div class="card-icon">${item.icon}</div>
            `;
            card.onclick = () => { if (canAfford) placeStructure(item.type); };
            container.appendChild(card);
        });
    }

    function showBuildMenu(tileIndex) {
        currentTileTarget = tileIndex;
        const menu = document.getElementById('build-menu');
        menu.innerHTML = ''; 
        
        const title = document.createElement('h2');
        title.style.color = 'white'; title.style.textAlign = 'center'; title.style.marginTop = '0';
        title.textContent = "Construction";
        menu.appendChild(title);

        const tabsDiv = document.createElement('div');
        tabsDiv.className = 'tab-container';
        ['Default', 'Electrical', 'Special'].forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'tab-btn' + (currentShopTab === t.toLowerCase() ? ' active' : '');
            btn.textContent = t;
            btn.onclick = () => switchTab(t.toLowerCase());
            tabsDiv.appendChild(btn);
        });
        menu.appendChild(tabsDiv);

        renderShopItems(menu);

        const cBtn = document.createElement('button');
        cBtn.textContent = "Cancel"; cBtn.style.width = "100%"; cBtn.style.padding = "10px";
        cBtn.style.background = "#d9534f"; cBtn.style.border = "none"; cBtn.style.color = "white";
        cBtn.style.borderRadius = "5px"; cBtn.style.marginTop = "10px"; cBtn.style.cursor = "pointer";
        cBtn.onclick = closeMenu;
        menu.appendChild(cBtn);

        if(document.getElementById('menu-overlay')) document.getElementById('menu-overlay').style.display = 'block';
        menu.style.display = 'block';
        document.getElementById('action-menu').style.display = 'none';
    }

    function placeStructure(type) {
        const blueprint = STRUCTURES[type];
        const cost = blueprint.levels[0].cost; 
        if (gold >= cost) {
            gold -= cost;
            const stats = blueprint.levels[0];
            tiles[currentTileTarget] = {
                type: type, level: 1, cost: cost, 
                goldEffect: stats.goldGen || 0, powerEffect: stats.powerGen || 0,
                isDisabled: false, element: null 
            };
            closeMenu(); renderGrid(); updateTurretIntervals(); updateUI(); toggleBuildMode(); 
        }
    }

    function showActionMenu(target, type, tileIndex = null) {
        currentTileTarget = target; currentTileTarget.tileIndex = tileIndex; 
        const blueprint = STRUCTURES[type];
        
        document.getElementById('menu-title').textContent = `${blueprint.icon} Level ${target.level}`;
        
        const isMax = target.level >= blueprint.levels.length;
        const nextStats = isMax ? null : blueprint.levels[target.level];
        const cost = isMax ? 0 : nextStats.cost;
        
        let info = "";
        if (type === 'bank') info = `Bonus: ${blueprint.levels[target.level-1].multiplier}x üí∞ | Drain: ${blueprint.levels[target.level-1].powerDrain}kW`;
        else if (isMax) info = "MAX LEVEL";
        else info = `Next: Level ${target.level+1}`;

        document.getElementById('menu-info').textContent = info;

        upgradeBtn.textContent = isMax ? "Maxed" : `Upgrade (${cost}üí∞)`;
        upgradeBtn.className = (isMax || gold < cost) ? 'disabled-btn' : '';
        
        const isVital = type === 'bed' || type === 'door';
        sellBtn.textContent = isVital ? 'Cannot Sell' : `Sell (${Math.floor(blueprint.levels[target.level-1].cost/2)}üí∞)`;
        sellBtn.className = isVital ? 'disabled-btn' : '';
        
        if(document.getElementById('menu-overlay')) document.getElementById('menu-overlay').style.display = 'flex';
        document.getElementById('action-menu').style.display = 'block';
        document.getElementById('build-menu').style.display = 'none';
    }

    function upgradeStructure() {
        const target = currentTileTarget;
        const blueprint = STRUCTURES[target.type];
        if (target.level >= blueprint.levels.length) return;
        const nextStats = blueprint.levels[target.level];
        if (gold >= nextStats.cost) {
            gold -= nextStats.cost;
            target.level++;
            if (target.type === 'door') {
                door.maxHp = nextStats.health; door.hp = door.maxHp; updateDoorVisuals();
            } else {
                Object.assign(target, { 
                    goldEffect: nextStats.goldGen||0, powerEffect: nextStats.powerGen||0
                });
                if (target.type === 'turret') updateTurretIntervals();
            }
            closeMenu(); renderGrid(); updateUI();
        }
    }

    function sellStructure() {
        if (currentTileTarget.type === 'bed' || currentTileTarget.type === 'door') return;
        gold += Math.floor(STRUCTURES[currentTileTarget.type].levels[currentTileTarget.level-1].cost/2);
        tiles[currentTileTarget.tileIndex] = null;
        closeMenu(); renderGrid(); updateTurretIntervals(); updateUI();
    }

    function closeMenu() {
        if(document.getElementById('menu-overlay')) document.getElementById('menu-overlay').style.display = 'none';
        document.getElementById('action-menu').style.display = 'none';
        document.getElementById('build-menu').style.display = 'none';
        currentTileTarget = null;
    }

    function toggleBuildMode() {
        isBuildMode = !isBuildMode; renderGrid(); 
        if (isBuildMode) closeMenu(); 
    }

    function handleTileClick(index) {
        if (isGameOver) return;
        closeMenu();
        if (tiles[index]) showActionMenu(tiles[index], tiles[index].type, index);
        else if (isBuildMode) showBuildMenu(index);
    }

    function renderGrid() {
        if(!gridElement) return;
        gridElement.innerHTML = '';
        tiles.forEach((tile, index) => {
            const div = document.createElement('div');
            div.className = 'grid-tile tooltip-container';
            div.onclick = () => handleTileClick(index);
            
            if (tile) {
                const bp = STRUCTURES[tile.type];
                const nextCost = tile.level < bp.levels.length ? bp.levels[tile.level].cost : 999999;
                if (gold >= nextCost) div.classList.add('upgrade-available');
                
                if (tile.isDisabled) {
                    div.classList.add('shutdown');
                    div.innerHTML = `<div class="shutdown-icon">‚ö†Ô∏è</div>`;
                }

                let icon = bp.icon;
                if (tile.type === 'turret') icon = `<span class="turret-bow" style="display:inline-block; transition:none; transform: rotate(${tile.currentRotation||0}deg)">${bp.icon}</span>`;
                
                div.innerHTML += `<span class="structure-icon">${icon}</span><span class="info-tooltip">${bp.icon} Lvl ${tile.level}</span>`;
                tile.element = div;
            }
            if (isBuildMode) {
                div.classList.add('grid-visual-on');
                if (!tile) div.innerHTML = '<div class="build-plus">+</div>';
            }
            gridElement.appendChild(div);
        });
    }

    // --- 10. INITIALIZATION ---
    document.addEventListener('keydown', e => { if(e.key==='e'||e.key==='E') toggleBuildMode(); });
    if(doorElement) doorElement.onclick = () => showActionMenu(door, 'door');
    if(upgradeBtn) upgradeBtn.onclick = upgradeStructure; 
    if(sellBtn) sellBtn.onclick = sellStructure; 
    if(closeBtn) closeBtn.onclick = closeMenu;

    function startWave() {
        if (isGameOver) return;
        const stats = MONSTER_LEVELS[Math.min(monster.level-1, MONSTER_LEVELS.length-1)];
        Object.assign(monster, { hp: stats.hp, maxHp: stats.hp, damage: stats.damage, attackRate: stats.attackRate, isAttacking: true });
        
        monsterElement.style.opacity = 1;
        monsterElement.style.top = `calc(0px - 120px)`; 
        monsterElement.style.left = '50%'; monsterElement.style.transform = 'translateX(-50%)'; 
        startMonsterAttack(); updateUI();
    }

    // Initial Runs
    updateDoorVisuals(); 
    renderGrid(); 
    updateUI(); 
    startWave(); 
    updateTurretIntervals();
</script>
</body>
</html>