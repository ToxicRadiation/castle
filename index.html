<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Silent Defense - Centered & Expanded</title>
    <style>
        :root {
            /* Compact scaling */
            --cell-size: clamp(18px, 4.0vw, 40px);
            
            /* These update dynamically via JS */
            --grid-cols: 15;
            --grid-rows: 4;
            
            --grid-width: calc(var(--grid-cols) * var(--cell-size));
            --grid-height: calc(var(--grid-rows) * var(--cell-size));

            --dark-color: #1a1a2e;
            --accent-color: #e94560;
            --gold-color: gold;
            --power-color: #00ffff;
            --door-color: #a0522d;
            --door-knob-color: #ffd700;
        }

        body {
            background-color: var(--dark-color);
            color: white;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            
            /* CENTERING FIX */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            touch-action: none;
        }

        /* --- UI CLUSTERS --- */
        #top-left-container {
            position: fixed; top: 10px; left: 10px;
            display: flex; align-items: flex-start; gap: 10px; z-index: 200;
        }

        #ui-bar {
            background-color: rgba(39, 39, 68, 0.95);
            border: 1px solid #444;
            padding: 5px 10px;
            border-radius: 4px;
            display: flex; flex-direction: column;
            gap: 2px;
            min-width: 80px;
        }

        .resource-display { font-size: 13px; font-weight: bold; white-space: nowrap; }

        #energy-monitor-container {
            background: rgba(0,0,0,0.9);
            border: 1px solid #333;
            width: 80px;
            height: 35px;
            display: flex; flex-direction: column;
            border-radius: 4px;
        }
        #energy-graph { width: 100%; height: 100%; display: block; }
        #kw-readout { font-size: 9px; color: #f55; text-align: right; margin-top: -10px; margin-right: 2px; position: relative; z-index: 2; text-shadow: 1px 1px 0 black; }

        #monster-stats-bar {
            position: fixed; top: 10px; right: 10px;
            background-color: rgba(68, 39, 39, 0.95);
            border: 1px solid #444;
            padding: 5px 10px;
            border-radius: 4px;
            z-index: 200;
            text-align: right;
        }
        .stat-display { font-size: 11px; color: #ccc; line-height: 1.4; }

        /* --- CENTER GAME AREA --- */
        #game-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Ensure it doesn't get pushed by margins */
            margin: 0; 
            padding: 0;
        }

        #game-container {
            position: relative;
            width: var(--grid-width);
            height: var(--grid-height);
            border: 3px solid #333;
            background-color: #0a0a0a;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            z-index: 10;
            transition: width 0.3s, height 0.3s;
        }

        /* --- DOOR --- */
        #door {
            position: absolute;
            top: calc(var(--cell-size) * -0.5); 
            left: 50%; transform: translateX(-50%);
            width: var(--cell-size);
            height: calc(var(--cell-size) * 0.5);
            background-color: var(--door-color);
            border: 2px solid black; border-bottom: none;
            cursor: pointer; z-index: 100;
        }
        #door-knob {
            width: 20%; height: 20%; background: var(--door-knob-color); border-radius: 50%;
            position: absolute; right: 20%; top: 50%;
        }

        /* --- MONSTER --- */
        #monster {
            position: absolute;
            top: calc(var(--cell-size) * -1.8); 
            left: 50%; transform: translateX(-50%);
            width: calc(var(--cell-size) * 1.5);
            height: calc(var(--cell-size) * 1.5);
            font-size: calc(var(--cell-size) * 1.2);
            display: flex; align-items: center; justify-content: center;
            z-index: 99; text-shadow: 0 0 10px red;
            transition: all 0.5s ease-out;
        }
        #monster-hp-visual {
            position: absolute; top: -5px; left: 0; width: 100%; height: 4px;
            background: #333; border: 1px solid white;
        }
        #monster-hp-fill { height: 100%; width: 100%; background: var(--accent-color); transition: width 0.2s; }

        /* --- HP BAR --- */
        #ui-door-hp-container {
            width: var(--grid-width);
            height: 10px;
            background: #222; border: 1px solid #555; border-top: none;
            position: relative;
            transition: width 0.3s;
        }
        #ui-door-hp-fill { height: 100%; background: #2e8b57; width: 100%; transition: width 0.2s; }

        /* --- BOTTOM LEFT CONTROLS --- */
        #mode-controls {
            position: fixed; bottom: 10px; left: 10px;
            display: flex; gap: 5px; z-index: 2000;
        }
        .mode-box {
            width: 60px; height: 35px;
            background-color: #222; color: #888; border: 1px solid #555;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; font-weight: bold; font-size: 10px;
            border-radius: 4px;
        }
        .mode-box.active-build { background-color: #2e7d32; border-color: #4caf50; color: white; }
        .mode-box.active-upgrade { background-color: #1565c0; border-color: #42a5f5; color: white; }
        .mode-box.active-sell { background-color: #c62828; border-color: #ef5350; color: white; }

        /* --- GRID TILES --- */
        #game-grid {
            display: grid;
            grid-template-columns: repeat(var(--grid-cols), var(--cell-size));
            grid-template-rows: repeat(var(--grid-rows), var(--cell-size));
        }
        .grid-tile {
            width: var(--cell-size); height: var(--cell-size);
            border: 1px solid #222;
            display: flex; align-items: center; justify-content: center;
            position: relative; cursor: pointer; box-sizing: border-box;
        }
        .structure-icon { font-size: calc(var(--cell-size) * 0.7); display: flex; align-items: center; justify-content: center; z-index: 20; }
        .build-plus { color: rgba(0,255,0,0.3); font-size: 20px; }

        /* --- VISUALS --- */
        .projectile { position: absolute; font-size: calc(var(--cell-size) * 0.4); color: yellow; z-index: 110; pointer-events: none; }
        .laser-beam-line { position: absolute; transform-origin: 0 50%; z-index: 500; pointer-events: none; box-shadow: 0 0 5px currentColor; }
        
        .floating-group {
            position: absolute; font-size: 12px; font-weight: bold; pointer-events: none;
            z-index: 150; animation: floatUp 1s ease-out forwards; white-space: nowrap; text-shadow: 1px 1px 0 #000;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); } }
        
        /* Grid Highlights */
        .grid-tile.upgrade-mode { background: rgba(0, 255, 255, 0.1); border-color: rgba(0, 255, 255, 0.5); }
        .grid-tile.sell-mode { background: rgba(255, 0, 0, 0.1); border-color: rgba(255, 0, 0, 0.5); }
        .grid-tile.shutdown { filter: grayscale(1) brightness(0.5); border: 1px solid red; }

        /* NEW: Affordable Glow (Green) */
        .grid-tile.affordable-glow {
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.3);
            border: 1px solid rgba(0, 255, 0, 0.5);
        }

        /* --- MENUS --- */
        #menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 9000; }
        .horror-menu {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 280px; background: #1a1a1a; border: 2px solid #5c4033;
            box-shadow: 0 0 30px #000; padding: 15px; z-index: 10000; text-align: center;
        }
        #build-menu {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 320px; max-height: 70vh; background: #111; border: 1px solid #444;
            box-shadow: 0 0 40px rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto; padding: 10px;
        }
        
        .tab-container { display: flex; gap: 2px; margin-bottom: 5px; }
        .tab-btn { flex: 1; background: #222; color: #777; border: 1px solid #333; padding: 5px; cursor: pointer; font-size: 11px; }
        .tab-btn.active { background: #333; color: gold; border-bottom: 2px solid gold; }
        
        .shop-card { 
            display: flex; justify-content: space-between; background: #1a1a1a; 
            margin-bottom: 5px; padding: 8px; border: 1px solid #333; cursor: pointer; 
        }
        .shop-card:hover { border-color: #666; }
        .shop-card.disabled { opacity: 0.5; pointer-events: none; }
        
        button.horror-btn { width: 100%; padding: 8px; margin-top: 5px; background: #222; border: 1px solid #444; color: #ccc; cursor: pointer; }
        button.horror-btn:hover { background: #333; color: white; }
        .danger { border-color: #800 !important; color: #f88 !important; }

        #game-toast {
            position: fixed; top: -50px; left: 50%; transform: translateX(-50%);
            background: #111; border: 1px solid gold; padding: 5px 15px; 
            z-index: 11000; transition: top 0.3s; font-weight: bold; font-size: 14px;
        }
        #game-toast.show { top: 10px; }
    </style>
</head>
<body>

    <div id="top-left-container">
        <div id="ui-bar">
            <div class="resource-display" style="color:var(--gold-color)">üí∞ <span id="gold-amount">100</span></div>
            <div class="resource-display" style="color:var(--power-color)">‚ö° <span id="power-amount">0</span></div>
            <div class="resource-display">Wave: <span id="wave-count">1</span></div>
        </div>
        <div id="energy-monitor-container">
            <canvas id="energy-graph" width="80" height="35"></canvas>
            <div id="kw-readout">0.0 kW</div>
        </div>
    </div>
    
    <div id="monster-stats-bar">
        <div class="stat-display" style="color:red; font-weight:bold;">DMG: <span id="monster-damage">0</span></div>
        <div class="stat-display">LVL: <span id="monster-wave">1</span></div>
    </div>

    <div id="game-wrapper">
        <div id="game-container">
            <div id="door" onclick="showActionMenu(door, 'door')">
                <div id="door-knob"></div>
            </div>
            
            <div id="monster">
                <div id="monster-hp-visual"><div id="monster-hp-fill"></div></div>
                üíÄ
            </div>
            
            <div id="game-grid"></div>
        </div>
        
        <div id="ui-door-hp-container">
            <div id="ui-door-hp-fill"></div>
        </div>
    </div>

    <div id="mode-controls">
        <div id="btn-build" class="mode-box" onclick="setMode('build')">BUILD (E)</div>
        <div id="btn-upgrade" class="mode-box" onclick="setMode('upgrade')">UPGR (R)</div>
        <div id="btn-sell" class="mode-box" onclick="setMode('sell')">SELL (Q)</div>
    </div>

    <div id="menu-overlay" onclick="closeMenu()"></div>
    
    <div id="action-menu" class="horror-menu">
        <h3 id="menu-title" style="margin:5px 0; color:var(--accent-color)">STRUCTURE</h3>
        <div id="menu-info" style="color:#888; font-size:12px; margin-bottom:10px;">...</div>
        <button id="upgrade-btn" class="horror-btn">UPGRADE</button>
        <button id="sell-btn" class="horror-btn danger">DISMANTLE</button>
        <button class="horror-btn" onclick="closeMenu()">CLOSE</button>
    </div>

    <div id="build-menu"></div>
    <div id="game-toast">MSG</div>

    <script>
    // --- 1. GAME CONSTANTS & DATA ---
    let gridCols = 15;
    let gridRows = 4;
    
    const DOOR_LEVELS = [
        { cost: 0, health: 300, color: '#5D4037', knob: '#FFD700', name: 'Rotting Wood' },
        { cost: 100, health: 500, color: '#37474F', knob: '#B0BEC5', name: 'Rusted Iron' },
        { cost: 250, health: 800, color: '#455A64', knob: '#FF5722', name: 'Reinforced Steel' },
        { cost: 500, health: 1200, color: '#FFC107', knob: '#00BCD4', name: 'Gilded Gate' },
        { cost: 1000, health: 2000, color: '#4A148C', knob: '#EA80FC', name: 'Void Barrier' },
    ];

    const STRUCTURES = {
        door: { levels: DOOR_LEVELS, icon: 'üö™', needsEnergy: false },
        bed: { levels: [{ cost: 0, goldGen: 100, powerGen: 1 }, { cost: 200, goldGen: 200, powerGen: 2 }, { cost: 500, goldGen: 450, powerGen: 3 }, { cost: 1200, goldGen: 900, powerGen: 5 }], icon: 'üõèÔ∏è', needsEnergy: false },
        generator: { levels: [{ cost: 100, powerGen: 1 }, { cost: 200, powerGen: 3 }, { cost: 450, powerGen: 6 }, { cost: 900, powerGen: 12 }], icon: '‚òÄÔ∏è', needsEnergy: false },
        turret: { levels: [{ cost: 150, damage: 20, fireRate: 1500 }, { cost: 300, damage: 35, fireRate: 1200 }, { cost: 600, damage: 60, fireRate: 900 }, { cost: 1200, damage: 100, fireRate: 700 }], icon: 'üèπ', needsEnergy: false },
        laser: { levels: [{ cost: 250, damage: 80, chargeTime: 3000, powerCost: 5, color: '#ff0000', width: 4 }, { cost: 600, damage: 200, chargeTime: 2800, powerCost: 8, color: '#ff8800', width: 6 }, { cost: 1400, damage: 500, chargeTime: 2500, powerCost: 12, color: '#ffff00', width: 8 }], icon: 'ü™Ñ', needsEnergy: true },
        bank: { levels: [{ cost: 500, multiplier: 1, powerDrain: 1 }, { cost: 1200, multiplier: 2, powerDrain: 2 }, { cost: 2500, multiplier: 4, powerDrain: 3 }], icon: 'üè¶', needsEnergy: true },
        repair: { levels: [{ cost: 300, healPct: 0.01, powerDrain: 2 }, { cost: 600, healPct: 0.02, powerDrain: 2 }, { cost: 1200, healPct: 0.04, powerDrain: 2 }], icon: 'üîß', needsEnergy: true }
    };

    const SHOP_ITEMS = [
        { type: 'generator', category: 'default', name: 'Solar', desc: '+Pwr', icon: '‚òÄÔ∏è' },
        { type: 'turret', category: 'default', name: 'Bow', desc: 'Dmg', icon: 'üèπ' },
        { type: 'laser', category: 'default', name: 'Wand', desc: 'High Dmg', icon: 'ü™Ñ' },
        { type: 'bank', category: 'electrical', name: 'Crypto', desc: 'Buff Turrets', icon: 'üè¶' },
        { type: 'repair', category: 'electrical', name: 'AutoFix', desc: 'Heal Door', icon: 'üîß' }
    ];

    const MONSTER_LEVELS = [
        { hp: 500, damage: 5, attackRate: 1500 },
        { hp: 800, damage: 10, attackRate: 1400 },
        { hp: 1300, damage: 20, attackRate: 1300 },
        { hp: 2100, damage: 40, attackRate: 1200 },
        { hp: 3500, damage: 60, attackRate: 1100 },
        { hp: 6000, damage: 90, attackRate: 1000 },
    ];

    // --- 2. STATE ---
    let gold = 100, power = 0, isGameOver = false;
    let currentShopTab = 'default', currentMode = 'none';
    let lastMonsterLevelTime = Date.now();
    const graphHistory = Array(30).fill(0); 
    
    // Grid & Land State
    let tiles = [];
    let landUpgrades = 0;
    const MAX_LAND_UPGRADES = 6;

    let door = { type: 'door', level: 1, hp: 300, maxHp: 300, nextCost: 100 };
    let monster = { level: 1, hp: 500, maxHp: 500, damage: 5, attackRate: 1500, isAttacking: true };

    let currentActionTarget = null;
    let monsterAttackInterval = null;
    let turretIntervals = [];

    // --- 3. INITIALIZATION ---
    function initGrid() {
        tiles = Array(gridCols * gridRows).fill(null).map((_, index) => {
            // Place bed in the lower middle
            const bedCol = Math.floor(gridCols / 2);
            const bedRow = gridRows - 2; 
            if (index === (bedRow * gridCols) + bedCol) {
                return { type: 'bed', level: 1, goldEffect: 100, powerEffect: 1, isDisabled: false, needsEnergy: false };
            }
            return null;
        });
    }
    initGrid();

    // --- 4. DOM ELEMENTS ---
    const uiGold = document.getElementById('gold-amount');
    const uiPower = document.getElementById('power-amount');
    const uiWave = document.getElementById('wave-count');
    const monsterWaveDisplay = document.getElementById('monster-wave');
    const monsterDmgDisplay = document.getElementById('monster-damage');
    const doorElement = document.getElementById('door');
    const monsterElement = document.getElementById('monster');
    const gridElement = document.getElementById('game-grid');
    const toastElement = document.getElementById('game-toast');
    const graphCanvas = document.getElementById('energy-graph');
    const ctx = graphCanvas.getContext('2d');

    // --- 5. HELPERS ---
    function showToast(msg) {
        toastElement.textContent = msg;
        toastElement.classList.add('show');
        setTimeout(() => toastElement.classList.remove('show'), 2000);
    }

    function animateFloat(text, element, color) {
        if (!element) return;
        const rect = element.getBoundingClientRect();
        const grp = document.createElement('div');
        grp.className = 'floating-group';
        grp.textContent = text;
        grp.style.color = color;
        // Shifted further down as requested (closer to center/bottom of cell)
        grp.style.left = (rect.left + rect.width/2) + 'px';
        grp.style.top = (rect.top + rect.height/1.5) + 'px'; 
        document.body.appendChild(grp);
        setTimeout(() => grp.remove(), 800);
    }

    function drawEnergyGraph(val) {
        graphHistory.shift(); graphHistory.push(val);
        ctx.clearRect(0,0,80,35);
        ctx.fillStyle = 'rgba(255,0,0,0.3)';
        ctx.beginPath();
        ctx.moveTo(0,35);
        const max = Math.max(10, ...graphHistory);
        graphHistory.forEach((v, i) => {
            const h = (v / max) * 35;
            ctx.lineTo((i/29)*80, 35-h);
        });
        ctx.lineTo(80,35);
        ctx.fill();
        document.getElementById('kw-readout').textContent = val.toFixed(1) + " kW";
    }

    // --- 6. GAME LOOPS ---
    setInterval(() => {
        if (isGameOver) return;
        let gInc = 0, pInc = 0, drain = 0;
        
        // Resource Calculation
        tiles.forEach(t => {
            if(t && !t.isDisabled) {
                if(t.goldEffect) gInc += t.goldEffect;
                if(t.powerEffect) pInc += t.powerEffect;
                if(t.type === 'bank' || t.type === 'repair') drain += STRUCTURES[t.type].levels[t.level-1].powerDrain || 0;
                
                // Repair Logic
                if(t.type === 'repair' && door.hp < door.maxHp) {
                    door.hp = Math.min(door.maxHp, door.hp + (door.maxHp * STRUCTURES.repair.levels[t.level-1].healPct));
                }
                
                // Visual Popup for Bed/Solar
                if (t.goldEffect || t.powerEffect) {
                    // Random slight stagger for visual variety, but mostly 1s loop
                    if (Math.random() > 0.5) animateFloat(`+${t.goldEffect||0}`, t.element, 'gold');
                    else if (t.powerEffect) animateFloat(`+${t.powerEffect}`, t.element, 'cyan');
                }
            }
        });
        
        gold += gInc;
        power += pInc;
        
        // Passive Door Heal
        if(door.hp > 0 && door.hp < door.maxHp) door.hp += (door.maxHp * 0.005);

        // Power Drain Logic
        if(drain > 0) {
            if(power >= drain) power -= drain;
            else tiles.forEach(t => { if(t && t.needsEnergy) t.isDisabled = true; });
        } else {
            tiles.forEach(t => { if(t && t.isDisabled && t.needsEnergy) t.isDisabled = false; });
        }
        
        drawEnergyGraph(drain);
        updateUI();
        updateAffordabilityVisuals();
    }, 1000);

    // Monster Loop
    function startMonsterAttack() {
        if(monsterAttackInterval) clearInterval(monsterAttackInterval);
        monsterAttackInterval = setInterval(() => {
            if(monster.isAttacking && !isGameOver) {
                monsterElement.style.transform = 'translate(-50%, 15px)';
                setTimeout(() => monsterElement.style.transform = 'translate(-50%, 0)', 150);
                door.hp -= monster.damage;
                if(door.hp <= 0) endGame();
                updateUI();
            }
        }, monster.attackRate);
    }

    function levelUpMonster() {
        if(isGameOver) return;
        monster.level++;
        lastMonsterLevelTime = Date.now();
        let stats = MONSTER_LEVELS[Math.min(monster.level-1, MONSTER_LEVELS.length-1)];
        if(monster.level > MONSTER_LEVELS.length) {
            stats = { hp: Math.floor(monster.maxHp * 1.3), damage: Math.floor(monster.damage * 1.2), attackRate: Math.max(500, monster.attackRate - 50) };
        }
        monster.maxHp = stats.hp; monster.hp = stats.hp; monster.damage = stats.damage; monster.attackRate = stats.attackRate;
        monster.isAttacking = true;
        monsterElement.style.opacity = 1;
        showToast(`WAVE ${monster.level}`);
        startMonsterAttack();
    }

    setInterval(() => {
        if(!isGameOver && Date.now() - lastMonsterLevelTime > 30000) levelUpMonster();
    }, 1000);

    // --- 7. COMBAT SYSTEM ---
    function updateTurretIntervals() {
        turretIntervals.forEach(clearInterval);
        turretIntervals = [];
        tiles.forEach((t, i) => {
            if(!t || t.isDisabled) return;
            if(t.type === 'turret') {
                const s = STRUCTURES.turret.levels[t.level-1];
                turretIntervals.push(setInterval(() => {
                    if(t.element && monster.isAttacking) {
                        const tr = t.element.getBoundingClientRect();
                        const mr = monsterElement.getBoundingClientRect();
                        const ang = Math.atan2(mr.top - tr.top, mr.left - tr.left) * (180/Math.PI);
                        t.element.querySelector('.structure-icon').style.transform = `rotate(${ang+45}deg)`;
                    }
                }, 100));
                turretIntervals.push(setInterval(() => {
                    if(monster.isAttacking && !isGameOver) fireProjectile(t, s);
                }, s.fireRate));
            }
            if(t.type === 'laser') {
                const s = STRUCTURES.laser.levels[t.level-1];
                turretIntervals.push(setInterval(() => {
                    if(monster.isAttacking && !isGameOver && power >= s.powerCost) {
                        power -= s.powerCost;
                        fireLaser(t, s);
                    }
                }, s.chargeTime));
            }
        });
    }

    function fireProjectile(t, s) {
        if(!t.element) return;
        const rect = t.element.getBoundingClientRect();
        const mRect = monsterElement.getBoundingClientRect();
        const p = document.createElement('div');
        p.className = 'projectile'; p.textContent = '‚ô¶Ô∏è';
        p.style.left = (rect.left + rect.width/2) + 'px';
        p.style.top = (rect.top + rect.height/2) + 'px';
        document.body.appendChild(p);
        
        let dmg = s.damage;
        tiles.forEach(ot => { if(ot && ot.type === 'bank' && !ot.isDisabled) dmg *= STRUCTURES.bank.levels[ot.level-1].multiplier; });

        p.style.transition = 'all 0.3s linear';
        p.getBoundingClientRect(); 
        p.style.left = (mRect.left + mRect.width/2) + 'px';
        p.style.top = (mRect.top + mRect.height/2) + 'px';
        
        setTimeout(() => {
            monster.hp -= dmg;
            if(monster.hp <= 0) monsterKilled();
            p.remove();
            updateUI();
        }, 300);
    }

    function fireLaser(t, s) {
        if(!t.element) return;
        const tr = t.element.getBoundingClientRect();
        const mr = monsterElement.getBoundingClientRect();
        const x1 = tr.left + tr.width/2, y1 = tr.top + tr.height/2;
        const x2 = mr.left + mr.width/2, y2 = mr.top + mr.height/2;
        const len = Math.sqrt((x2-x1)**2 + (y2-y1)**2);
        const ang = Math.atan2(y2-y1, x2-x1) * (180/Math.PI);
        
        const b = document.createElement('div');
        b.className = 'laser-beam-line';
        b.style.width = len + 'px'; b.style.height = s.width + 'px';
        b.style.background = s.color; b.style.color = s.color;
        b.style.left = x1 + 'px'; b.style.top = y1 + 'px';
        b.style.transform = `rotate(${ang}deg) translateY(-50%)`;
        document.body.appendChild(b);
        
        monster.hp -= s.damage;
        if(monster.hp <= 0) monsterKilled();
        updateUI();
        setTimeout(() => b.remove(), 200);
    }

    function monsterKilled() {
        gold += monster.maxHp * 0.2;
        animateFloat(`+${Math.floor(monster.maxHp*0.2)}`, monsterElement, 'gold');
        monster.isAttacking = false;
        clearInterval(monsterAttackInterval);
        monsterElement.style.opacity = 0;
        setTimeout(levelUpMonster, 2000);
    }

    // --- 8. UI UPDATES ---
    function updateUI() {
        uiGold.textContent = Math.floor(gold).toLocaleString();
        uiPower.textContent = Math.floor(power).toLocaleString();
        uiWave.textContent = monster.level;
        monsterWaveDisplay.textContent = monster.level;
        monsterDmgDisplay.textContent = monster.damage;
        
        document.getElementById('ui-door-hp-fill').style.width = Math.max(0, (door.hp / door.maxHp) * 100) + '%';
        document.getElementById('monster-hp-fill').style.width = Math.max(0, (monster.hp / monster.maxHp) * 100) + '%';
        
        ['build','upgrade','sell'].forEach(m => {
            const b = document.getElementById(`btn-${m}`);
            if(currentMode === m) b.classList.add(`active-${m}`);
            else b.classList.remove(`active-${m}`);
        });

        const dStats = DOOR_LEVELS[Math.min(door.level-1, DOOR_LEVELS.length-1)];
        doorElement.style.backgroundColor = dStats.color;
        document.getElementById('door-knob').style.backgroundColor = dStats.knob;
    }
    
    // NEW: Affordability Glow Loop
    function updateAffordabilityVisuals() {
        tiles.forEach((t, i) => {
            if(!t || !t.element) return;
            
            t.element.classList.remove('affordable-glow');
            
            // Check if upgradeable and affordable
            const s = STRUCTURES[t.type];
            if (t.level < s.levels.length) {
                const nextCost = s.levels[t.level].cost;
                if (gold >= nextCost) {
                    t.element.classList.add('affordable-glow');
                }
            }
        });
    }

    function setMode(m) {
        currentMode = (currentMode === m) ? 'none' : m;
        closeMenu(); renderGrid(); updateUI();
    }

    // --- 9. RENDERING ---
    function renderGrid() {
        gridElement.innerHTML = '';
        
        // Dynamic Grid Sizing via CSS Vars
        document.documentElement.style.setProperty('--grid-cols', gridCols);
        document.documentElement.style.setProperty('--grid-rows', gridRows);
        
        tiles.forEach((t, i) => {
            const div = document.createElement('div');
            div.className = 'grid-tile';
            div.onclick = () => handleTileClick(i);
            
            if(t) {
                const s = STRUCTURES[t.type];
                
                // Logic for Upgrade Mode highlighting
                if(currentMode === 'upgrade') {
                    // Only highlight yellow if NOT maxed
                    if (t.level < s.levels.length) {
                        div.classList.add('upgrade-mode');
                    }
                }
                
                if(currentMode === 'sell') div.classList.add('sell-mode');
                if(t.isDisabled) div.classList.add('shutdown');
                
                div.innerHTML = `<div class="structure-icon">${s.icon}</div>`;
                t.element = div;
            } else {
                if(currentMode === 'build') div.innerHTML = '<div class="build-plus">+</div>';
            }
            gridElement.appendChild(div);
        });
    }

    function handleTileClick(i) {
        if(isGameOver) return;
        const t = tiles[i];
        if(currentMode === 'build' && !t) showBuildMenu(i);
        else if(currentMode === 'upgrade' && t) upgradeStructure(i);
        else if(currentMode === 'sell' && t) sellStructure(i);
        else if(t) showActionMenu(t, t.type, i);
    }

    // --- 10. MENUS & SHOPS ---
    function showBuildMenu(i) {
        const menu = document.getElementById('build-menu');
        menu.innerHTML = '';
        
        const tabs = document.createElement('div'); tabs.className = 'tab-container';
        // Explicitly adding LAND here
        ['Default','Electrical','Land'].forEach(c => {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${currentShopTab===c.toLowerCase()?'active':''}`;
            btn.textContent = c;
            btn.onclick = () => { currentShopTab = c.toLowerCase(); showBuildMenu(i); };
            tabs.appendChild(btn);
        });
        menu.appendChild(tabs);
        
        if (currentShopTab === 'land') {
             // LAND EXPANSION CARD
             const landCostGold = 10000 * Math.pow(30, landUpgrades);
             const landCostPower = 1000 * Math.pow(30, landUpgrades);
             
             const div = document.createElement('div');
             const isMaxed = landUpgrades >= MAX_LAND_UPGRADES;
             const canAfford = gold >= landCostGold && power >= landCostPower;
             
             div.className = `shop-card ${!isMaxed && canAfford ? '' : 'disabled'}`;
             
             let descText = "";
             if (landUpgrades < 3) descText = "EXPAND WIDTH (+2 Columns)";
             else descText = "EXPAND DEPTH (+1 Row)";
             if (isMaxed) descText = "MAX SIZE REACHED";

             div.innerHTML = `
                <div style="text-align:left">
                    <div style="font-weight:bold; font-size:12px; color:white">üó∫Ô∏è BUY LAND</div>
                    <div style="font-size:10px; color:#aaa">${descText}</div>
                </div>
                <div style="font-size:10px; font-weight:bold; color:gold; text-align:right">
                    ${isMaxed ? 'MAX' : `${landCostGold.toLocaleString()}üí∞<br>${landCostPower.toLocaleString()}‚ö°`}
                </div>
            `;
            div.onclick = () => {
                if (!isMaxed && canAfford) {
                    gold -= landCostGold;
                    power -= landCostPower;
                    buyLandUpgrade();
                    closeMenu();
                }
            };
            menu.appendChild(div);

        } else {
            // NORMAL ITEMS
            SHOP_ITEMS.filter(it => it.category === currentShopTab).forEach(it => {
                const cost = STRUCTURES[it.type].levels[0].cost;
                const div = document.createElement('div');
                div.className = `shop-card ${gold>=cost?'':'disabled'}`;
                div.innerHTML = `
                    <div style="text-align:left">
                        <div style="font-weight:bold; font-size:12px; color:white">${it.icon} ${it.name}</div>
                        <div style="font-size:10px; color:#aaa">${it.desc}</div>
                    </div>
                    <div style="font-size:12px; font-weight:bold; color:gold">${cost}</div>
                `;
                div.onclick = () => {
                    if(gold >= cost) {
                        gold -= cost;
                        tiles[i] = { type: it.type, level: 1, needsEnergy: STRUCTURES[it.type].needsEnergy, goldEffect: STRUCTURES[it.type].levels[0].goldGen||0, powerEffect: STRUCTURES[it.type].levels[0].powerGen||0 };
                        closeMenu(); renderGrid(); updateTurretIntervals(); setMode('none');
                    }
                };
                menu.appendChild(div);
            });
        }
        document.getElementById('menu-overlay').style.display = 'block';
        menu.style.display = 'block';
    }

    function buyLandUpgrade() {
        landUpgrades++;
        let newCols = gridCols;
        let newRows = gridRows;
        let newTiles = [];
        
        if (landUpgrades <= 3) {
            // EXPAND WIDTH (+1 Left, +1 Right) -> +2 cols total
            newCols += 2;
            newTiles = Array(newCols * newRows).fill(null);
            
            // Re-map tiles: Shift X by +1
            for(let y=0; y<gridRows; y++) {
                for(let x=0; x<gridCols; x++) {
                    const oldIdx = y * gridCols + x;
                    const newIdx = y * newCols + (x + 1);
                    newTiles[newIdx] = tiles[oldIdx];
                }
            }
        } else {
            // EXPAND DEPTH (+1 Bottom) -> +1 row
            newRows += 1;
            newTiles = Array(newCols * newRows).fill(null);
            // Copy existing
            for(let i=0; i<tiles.length; i++) {
                newTiles[i] = tiles[i];
            }
        }
        
        gridCols = newCols;
        gridRows = newRows;
        tiles = newTiles;
        
        showToast("TERRITORY EXPANDED");
        renderGrid();
        updateTurretIntervals();
    }

    function showActionMenu(target, type, idx) {
        currentActionTarget = { t: target, i: idx };
        const menu = document.getElementById('action-menu');
        const s = STRUCTURES[type];
        document.getElementById('menu-title').textContent = `${s.icon} LVL ${target.level}`;
        
        const isMax = target.level >= s.levels.length;
        let next = isMax ? null : s.levels[target.level];
        if(type === 'door') next = { cost: door.nextCost };
        
        const inf = document.getElementById('menu-info');
        inf.textContent = isMax && type!=='door' ? "MAX LEVEL" : `UPGRADE: ${next.cost}üí∞`;
        
        const upBtn = document.getElementById('upgrade-btn');
        upBtn.textContent = "UPGRADE";
        upBtn.onclick = () => upgradeStructure(idx===undefined ? 'door' : idx);
        
        const selBtn = document.getElementById('sell-btn');
        if(type === 'bed' || type === 'door') selBtn.style.display = 'none';
        else {
            selBtn.style.display = 'block';
            selBtn.onclick = () => sellStructure(idx);
        }

        document.getElementById('menu-overlay').style.display = 'block';
        menu.style.display = 'block';
    }

    function upgradeStructure(idx) {
        if(idx === 'door') {
            if(gold >= door.nextCost) {
                gold -= door.nextCost;
                door.level++;
                door.maxHp = Math.floor(door.maxHp * 1.5); door.hp = door.maxHp;
                door.nextCost = Math.floor(door.nextCost * 1.8);
                showToast("DOOR REINFORCED"); closeMenu(); updateUI();
            } else showToast("NEED MORE GOLD");
            return;
        }
        
        const t = tiles[idx];
        const s = STRUCTURES[t.type];
        if(t.level >= s.levels.length) return;
        const next = s.levels[t.level];
        if(gold >= next.cost) {
            gold -= next.cost;
            t.level++;
            Object.assign(t, { goldEffect: next.goldGen||0, powerEffect: next.powerGen||0 });
            showToast("UPGRADED"); closeMenu(); renderGrid(); updateTurretIntervals();
        } else showToast("NEED MORE GOLD");
    }

    function sellStructure(idx) {
        if(!tiles[idx]) return;
        gold += 50; 
        tiles[idx] = null;
        showToast("DISMANTLED");
        closeMenu(); renderGrid(); updateTurretIntervals();
    }

    function closeMenu() {
        document.getElementById('menu-overlay').style.display = 'none';
        document.querySelectorAll('.horror-menu, #build-menu').forEach(e => e.style.display = 'none');
    }

    function endGame() {
        isGameOver = true;
        clearInterval(monsterAttackInterval);
        document.body.innerHTML = `<h1 style="margin-top:40vh; color:red">GAME OVER</h1><button onclick="location.reload()" style="padding:10px; font-size:20px">RETRY</button>`;
    }

    document.addEventListener('keydown', e => {
        if(e.key==='e'||e.key==='E') setMode('build');
        if(e.key==='r'||e.key==='R') setMode('upgrade');
        if(e.key==='q'||e.key==='Q') setMode('sell');
        if(e.key==='Escape') { setMode('none'); closeMenu(); }
    });

    renderGrid(); startMonsterAttack(); updateUI();
    </script>
</body>
</html>